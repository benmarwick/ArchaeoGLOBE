---
title: "archeoglobe"
author: "Nick Gauthier"
date: "August 23, 2018"
output: 
  html_document: 
    highlight: pygments
    keep_md: yes
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Sample analysis code for the ArchaeoGlobe database.

## Setup
Import packages needed for analysis. We'll use packages from the `tidyverse`, such as `readr`, `dplyr`, and `ggplot2` for data import, processing, and plotting. The `sf` package will help us work with shapefiles in a tidy context.
```{r}
library(tidyverse)
library(sf)
# devtools::install_github("jbaileyh/geogrid")
library(geogrid)
library(mgcv)
```

## Data import
Read in the latest version of the ArchaeoGLOBE database.
```{r}
dat <- read_csv('../data/ArchaeoGLOBE_Public_Data_2018_08_14.csv') %>%
  filter(RN_SITES != '17899')
```

Take a closer look at the database to make sure all is well.
```{r}
glimpse(dat)
```

Next import the regions shapefile.
```{r}
regions <- st_read('../data/ArchaeGLOBE_Regions.shp')
```

Take a closer look.
```{r}
glimpse(regions)
```



## Plotting
Next let's explore some sample plots
```{r}
ggplot() + 
  geom_sf(data = regions) +
  theme_minimal() +
  ggtitle('ArchaeoGLOBE regions')
```

Next try plotting the estimated number of sites. First define an ordering for the number of sites estimate, to aid in plotting.
```{r}
n_sites <- c('< 50', '50-249', '250-499', '500-999', '> 1000')
```

Now, modify the `RN_SITES` column to be an ordered factor using the above sequence. Then calculate the most common response for each region, and plot the result
```{r}
dat %>% 
  select(REGION_ID, RN_SITES) %>% # just select the columns of interest
  mutate(RN_SITES = ordered(RN_SITES, levels = n_sites)) %>% # create an ordered factor
  group_by(REGION_ID) %>% # focus on each region separately
  count(RN_SITES) %>% # count the number of responses for each site number
  slice(which.max(n)) %>% # choose the most selected response for each region
  left_join(regions, ., by = c('Archaeo_ID' = 'REGION_ID')) %>% # join to the region shapes
  ggplot() + # plot
    geom_sf(aes(fill = RN_SITES), size=.3, color = 'white', alpha=0.9) +
    theme_minimal() +
    ggtitle('ArchaeoGLOBE regions', 'Estimated number of excavated sites')

```

```{r}
par(mfrow = c(8, 5), mar = c(0, 0, 2, 0))
for (i in 1:40) {
  new_cells <- calculate_grid(shape = regions, grid_type = "hexagonal", seed = i)
  plot(new_cells, main = paste("Seed", i, sep = " "))
}
```
```{r}
new_cells_hex <- calculate_grid(shape = regions, grid_type = "hexagonal", seed = 23)
resulthex <- assign_polygons(regions, new_cells_hex)

dat %>% 
  select(REGION_ID, RN_SITES) %>% # just select the columns of interest
  mutate(RN_SITES = ordered(RN_SITES, levels = n_sites)) %>% # create an ordered factor
  group_by(REGION_ID) %>% # focus on each region separately
  count(RN_SITES) %>% # count the number of responses for each site number
  slice(which.max(n)) %>% # choose the most selected response for each region
  left_join(resulthex, ., by = c('Archaeo_ID' = 'REGION_ID')) %>% # join to the region shapes
  ggplot() + # plot
    geom_sf(aes(fill = RN_SITES), size=.3, color = 'white', alpha=0.9) +
    theme_minimal() +
    ggtitle('ArchaeoGLOBE regions', 'Estimated number of excavated sites')
```


## Analysis of expertise
How does the self-professed level of expertise vary in each region over time?

Before doing everything else, let's plot out the data.
```{r}
dat %>%
  select(1:18) %>% # select the first 18 columns
  gather(period, expertise, 9:18) %>%
  mutate(period = parse_number(period),
         expertise = ordered(expertise, levels = c('None', 'Low', 'High'))) %>%
  ggplot(aes(period, expertise, group = REGION_LAB)) +
  scale_x_reverse() +
  stat_smooth(geom='line', alpha=0.3, se=FALSE, method = 'loess') +
  facet_wrap(~WORLD_LAB) +
  theme_minimal()
```

The LOESS fits may be deceiving, as there might be very few datapoints per region. What if we restrict it to linear fits?

```{r}
dat %>%
  select(1:18) %>% # select the first 18 columns
  gather(period, expertise, 9:18) %>%
  mutate(period = parse_number(period),
         expertise = ordered(expertise, levels = c('None', 'Low', 'High'))) %>%
  ggplot(aes(period, expertise, group = REGION_LAB)) +
  scale_x_reverse() +
  stat_smooth(geom='line', alpha=0.3, se=FALSE, method = 'lm') +
  facet_wrap(~WORLD_LAB) +
  theme_minimal()
```

The above plot might still be somewhat misleading, because we aren't accounting for individual observer effects, such as observers who are more likely to enter high expertise regardless of region. Let's try fitting a multilevel model.

Inspiration for this analysis from here: https://cdn.rawgit.com/eric-pedersen/mgcv-esa-workshop/master/example-forest-health.html

First, make a dataset just of the expertise data.
```{r}
exp_dat <-dat %>%
  select(1:18) %>% # select the first 18 columns
  gather(period, expertise, 9:18) %>% # convert the data to long format, with one expertise value per row
  mutate(period = parse_number(period) * -1, # convert time period labels to years
         expertise = ordered(expertise, levels = c('None', 'Low', 'High')),
         exp_num = as.numeric(expertise),
         WORLD_LAB = as.factor(WORLD_LAB))
```

Next fit some models.
First fit only a global smooth term. The first model fits only the global trend, the second fits a global trend w/ group-specific intercepts, and the third penalizes both the smooth term and the group-specific intercepts toward the global mean.
```{r}
mod1 <- gam(exp_num ~ s(period, bs = 'cr'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = F)
mod2 <- gam(exp_num ~ s(period, bs = 'cr') + REGION_LAB, 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = F)
mod3 <- gam(exp_num ~ s(period, bs = 'cr') + s(REGION_LAB, bs = 're'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = T)

exp_dat$REGION_LAB %>% unique
plot(mod1)
plot(mod2)
plot(mod3)
```

```{r}
mod4 <- gam(exp_num ~ s(period, bs = 'cr') + s(period, WORLD_LAB, bs = 'fs'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = F)
mod5 <- gam(exp_num ~ ti(period) + ti(period, WORLD_LAB, bs = c('tp', 're')) + ti(WORLD_LAB, bs = 're'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = F)
mod6 <- gam(exp_num ~ ti(period) + ti(period, WORLD_LAB, bs = c('tp', 're')) + ti(WORLD_LAB, bs = 're'),
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = T)

plot(mod4)
```


```{r}
mod7 <- gam(exp_num ~ s(period, bs = 'cr') + s(period, by = WORLD_LAB, bs = 'cr') + s(WORLD_LAB, bs = 're'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = T)
```

```{r}
mod8 <- gam(exp_num ~ s(period, WORLD_LAB, bs = 'fs'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = F)
mod9 <- gam(exp_num ~ te(period, WORLD_LAB, bs = c('tp', 're')) + s(WORLD_LAB, bs = 're'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = T)
```

```{r}
mod10 <- gam(exp_num ~ s(period, bs = 'cr', by = WORLD_LAB) + s(WORLD_LAB, bs = 're'), 
            data = exp_dat, family = ocat(R = 3), 
            method = 'REML', select = T)
```

```{r}
summary(mod10)
plot(mod10)
```

